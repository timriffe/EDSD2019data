---
pagetitle: "Combining Data Sources"
title: | 
  | Data Wrangling for EDSDers
  | \vspace{1.5cm} \LARGE\emph{Module outline}
author: |
  | Centre d'Estudis Demografics
  | 11-14 Nov, 2019
  | Tim Riffe
  | Max-Planck-Institute for Demographic Research
date: "13 Nob, 2019"
output:
  html_document:
    number_sections: yes
    toc: yes
params:
  output_dir: "../EDSD2019data/docs"
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center}\includegraphics[trim=0 0 0 8cm, width=6cm, ]{assets/MPIDR_square_color.pdf}\\[\bigskipamount]}
- \posttitle{\end{center}}
bibliography: references.bib
---


<a href="https://github.com/timriffe/EDSD2019data" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

I've download the World Values Survey Longitudinal file from here: [http://www.worldvaluessurvey.org/](http://www.worldvaluessurvey.org/), which ships in 4 different data formats, including `.rds`! Download it too, and unzip it in the `Data` folder for this project. Let's see what's inside.

Packages we'll use:
```{r, message = FALSE, warning = FALSE}
library(here)
library(tidyverse)
```

This dataset is quite wide because they ask tons of questions. Many of them are super intersting. The objective now is to merge some variable from WVS into the a WPP demographic dataset. We need to solve the following problems in order to have merge variables that are sufficiently harmonized for this to work. Meaning: 

1. Age should either be in clean single ages or clean grouped ages. For similicity we'll use 5-year age groups. 
2. We need harmonized years. WPP give 5-year intervals, so we can year-group the WVS data.
3. We need to get some sort of prevalence or mean measure per 5-year age group in some interesting variable (by year, age, sex and country). We can do this using the `summarize()` function instead of regression. Regression would be cool though.
4. We need to reshape the WPP data to long (`pivot_longer`)
```{r}
WVS <- readRDS(
  here::here("Data",
             "F00008390-WVS_Longitudinal_1981_2016_r_v20180912.rds"))
#colnames(WVS)
# country code
unique(WVS$S003)
# year
unique(WVS$S020)
# homogeneous weight (all countries equal N = 1500)
# S019 
# sex
unique(WVS$X001)
# age
sort(unique(WVS$X003))
# cohort
#WVS$X002
# A015 "People can be trusted"
table(WVS$A165)
```

Select ISO, Year, Age, Sex, Person Weight, Trust
```{r}
WVS <- 
  WVS %>% 
  select(ISO = S003, 
         year = S020, # Year
         sex = X001, # Sex
         age = X003, # age
         trust = A165,
         pwt = S017) %>%  # trust
  #pull(sex) %>% table() # spot check for negative age
  filter(age >= 0,
         trust > 0,
         sex > 0) %>% 
  mutate(year = year - year %% 5,
         age = age - age %% 5,
         distrust = trust - 1,
         trust = 1 - distrust) %>% 
  group_by(ISO, sex, year, age) %>% 
  summarize(trust = sum(trust * pwt) / sum(pwt),
            distrust = sum(distrust * pwt) / sum(pwt)) %>% 
  ungroup() 
```

Now let's talk about what one might join and how. Here's a dataset that uses the same country codes.
```{r}
#install.packages("wpp2019")
library(wpp2019)
data(mxF)
data(mxM)
# not bad coincidence!
#intersect(unique(mxF$country_code),unique(WVS$S003))
head(mxF)
px_to_lx <- function(px){
  n <- length(px)
  c(1,cumprod(px)[-n])
}
# add sex column to both datasets
mxF <- mxF %>% 
  mutate(sex = 2)
mxM <- mxM %>% 
  mutate(sex = 1)
# bind two sexes together
mxT <- rbind(mxF, mxM)
# send it down the pipe
mxT <- 
  mxT %>% 
  pivot_longer(cols = 4:33, 
               names_to = "year",
               values_to = "nMx") %>% 
  mutate(year = substr(year, 
                       start = 1, 
                       stop = 4),
         year = as.integer(year),
         # in a case_when go from the
         # specific to the general
         AgeInt = case_when(
           age == 0 ~ 1,
           age == 1 ~ 4,
           TRUE ~ 5 # catch-all
         ),
         nAx = AgeInt / 2,
         qx = ifelse(age == 100, 
                     1,
                     (AgeInt * nMx) / 
           (1 + (AgeInt - nAx) * nMx))) %>% 
  arrange(country_code, sex, year, age) %>% 
  group_by(country_code, sex, year) %>% 
  mutate(px = 1 - qx,
         lx = px_to_lx(px),
         dx = qx * lx,
         Lx = dx / nMx) %>% 
  rename(ISO = country_code) %>% 
  filter(year >= 1980,
         year <= 2015)
```

Now we're ready to do our join operation. Look at how much overhead was needed in order to turn these two datasets into joinable things!! The lesson: you need to have 1) identically named and 2) identically coded columns on which to join. It would have been a heck of alot easier to join if we only needed to join on ISO codes! But hey, we have super awesome detailed and nested demographic data that we wish to preserve in the name of science.

```{r}
mxT <- left_join(
  mxT, 
  WVS, 
  by = c("ISO","sex","year","age"))

mxT %>% 
  group_by(ISO, sex, year) %>% 
  mutate(remove = all(is.na(trust))) %>% 
  ungroup() %>% 
  filter(!remove)
```

