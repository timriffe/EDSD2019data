---
pagetitle: "Civil registration data"
title: | 
  | Data Wrangling for EDSDers
  | \vspace{1.5cm} \LARGE\emph{Module outline}
author: |
  | United Nations Population Division
  | 11-14 Nov, 2019
  | Tim Riffe
  | Max-Planck-Institute for Demographic Research
date: "12 Nov, 2019"
output:
  html_document:
    number_sections: yes
    toc: yes
params:
  output_dir: "../EDSD2019data/docs"
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center}\includegraphics[trim=0 0 0 8cm, width=6cm, ]{assets/MPIDR_square_color.pdf}\\[\bigskipamount]}
- \posttitle{\end{center}}
bibliography: references.bib
---


<a href="https://github.com/timriffe/EDSD2019data" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

We're talking about big birth, death, and marriage flat files, as commonly produced by Spain, USA, Mexico, and others. Anyone know of other countries that openly share data in this form? Let's compile a list of the ones we know about and add links here. The tools we use today could be useful for any of them. Let's make a list of open data we know about:

1. USA [https://www.cdc.gov/nchs/data_access/vitalstatsonline.htm](https://www.cdc.gov/nchs/data_access/vitalstatsonline.htm)
2. Spain [ine.es](https://ine.es/dyngs/INEbase/es/operacion.htm?c=Estadistica_C&cid=1254736177008&menu=resultados&secc=1254736195450&idp=1254735573002) This link for mortality, but there are other pages for marriage, natality, and other things.
3. Mexico? links broken?
4. 

Download the USA 2018 Natality file, and unzip it in the Data folder (around 5Gb). You can rezip it if you want as a `.gz` file or similar, if you want to have it take up less space. We'll just read in selected columns and then do fun things from there. This is really quite fast and easy to do using the `readr` package and browsing the data documetation.

Load packages
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(readr)
```

Give `read_fwf()` a whirl. This worked on the first try after glancing at the options in the help file (type `?read_fwf` in the console).
```{r}
pos <- fwf_positions(
         start = c(9, 13, 19, 21, 23, 75, 147), 
         end = c(12, 14, 20, 22, 23, 76, 148), 
         col_names = c("year", "month", "hour","minute","weekday","mage","fage"))

NAT <- read_fwf(
  here::here("Data","Nat2018PublicUS.c20190509.r20190717.txt"), 
  pos)
print(object.size(NAT), units ="Mb")
head(NAT)
```

First let's fix the month and time variables, which parsed as character due to leading zeros. We can use `group_by()` and `summarize()` to tabulate as we please.
```{r}
NAT <- 
  NAT %>% 
  mutate(month = as.integer(month),
         hour = as.integer(hour),
         minute = as.integer(minute))
```
Check missing time: 316 cases
```{r}
NAT %>% 
  filter(minute == 99,
         hour == 99) %>% 
  nrow()
```
For the exercises I have in mind it's probably fine to throw these cases out if using the `time` variable as it's such a small fraction of births. But we could also redistribute them. In this case how? If we're lazy we might do so proportional to the distribution of births matched to all the characteristics they have in common. That means, of these 316 births, how many were in each month, with mothers and fathers of given ages, etc: Create a big multidimensional probability distribution for each combination of knowns for each birth. It's laborious, but also rather rigorous. Even more rigorous would be to include information on other variables you might not be interested in for the redistribution. @dudel2018estimating does something similar for missing ages of fathers. Before such an exercise we'd want to do a tabulation, which will make these data quite a bit lighter.

```{r}
NAT <- NAT %>% 
  group_by(mage, hour, minute) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  mutate(dfrac = (hour * 60 + minute) / (24*60),
         dfrac[minute == 99] <- NA) %>% 
  select(mage, n, dfrac) %>% 
  group_by(mage) %>% 
  mutate(bfrac = n / sum(n[!is.na(dfrac)]),
         n = n + bfrac * 
                   ifelse(
                     sum(is.na(dfrac)) == 0, # condition
                     0,                      # true
                     n[is.na(dfrac)])) %>%   # false
  ungroup() %>% 
  filter(!is.na(dfrac)) %>% 
  mutate(minute = floor((dfrac * (60 * 24)) %% 60),
         hour = floor((dfrac * (60 * 24)) - minute)) 
# a <- c(1,4,56,6,76,5)
# a[is.na(a)] * 1
```

Now we've redistributed births of unknown time of day according to the distribution of known time of day within each mother age. The *within* part of this was dealt with by the `group_by(mage)` statement, where one could add another variable or two to make it finer. 

```{r}

NAT %>% 
  ggplot()


```




# References



